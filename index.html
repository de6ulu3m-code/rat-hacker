<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RatOS: GLITCH</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; touch-action: none; }
        canvas { display: block; filter: contrast(120%) brightness(110%); }
        .hud { position: absolute; top: 10px; width: 100%; text-align: center; color: #0f0; pointer-events: none; font-size: 1.2rem; z-index: 10; }
        #stealth-btn { position: absolute; bottom: 40px; right: 40px; width: 80px; height: 80px; background: rgba(0,255,255,0.2); border: 2px solid #0ff; border-radius: 50%; color: #0ff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; }
        #joystick { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border: 2px solid #555; border-radius: 50%; }
        #knob { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: #fff; border-radius: 50%; }
    </style>
</head>
<body>

<div class="hud">–£–ó–õ–´: <span id="cores">0</span>/5 | –®–£–ú: <span id="noise">0</span>%</div>
<canvas id="game"></canvas>
<div id="joystick"><div id="knob"></div></div>
<div id="stealth-btn">STEALTH</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let player = { x: 50, y: 50, r: 15, invisible: 0, noise: 0 };
    let hunter = { x: canvas.width/2, y: canvas.height/2, r: 30, speed: 1.5, alert: 0 };
    let nodes = [];
    let walls = [];
    let joy = { x: 0, y: 0, active: false };
    let glitchEffect = 0;

    function createWorld() {
        walls = [];
        for(let i=0; i<12; i++) {
            walls.push({
                x: Math.random()*(canvas.width-100), 
                y: Math.random()*(canvas.height-100), 
                w: 60+Math.random()*100, 
                h: 20, 
                moving: Math.random() > 0.7
            });
        }
        nodes = [];
        for(let i=0; i<5; i++) nodes.push({x: 50+Math.random()*(canvas.width-100), y: 50+Math.random()*(canvas.height-100), active: true});
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    document.getElementById('stealth-btn').addEventListener('touchstart', () => { if(player.invisible <= 0) player.invisible = 120; });
    document.getElementById('joystick').addEventListener('touchstart', () => joy.active = true);
    window.addEventListener('touchmove', (e) => {
        if (!joy.active) return;
        const rect = document.getElementById('joystick').getBoundingClientRect();
        const dx = e.touches[0].clientX - (rect.left + 50);
        const dy = e.touches[0].clientY - (rect.top + 50);
        const d = Math.sqrt(dx*dx + dy*dy);
        joy.x = dx / d; joy.y = dy / d;
        let p = Math.min(d, 40);
        document.getElementById('knob').style.transform = `translate(${joy.x * p}px, ${joy.y * p}px)`;
        player.noise = p * 2.5; // –ß–µ–º —Å–∏–ª—å–Ω–µ–µ —Ç—è–Ω–µ—à—å –¥–∂–æ–π—Å—Ç–∏–∫, —Ç–µ–º –±–æ–ª—å—à–µ —à—É–º–∞
    });
    window.addEventListener('touchend', () => { joy.active = false; joy.x = 0; joy.y = 0; player.noise = 0; document.getElementById('knob').style.transform = 'translate(0,0)'; });

    function update() {
        if (glitchEffect > 0) glitchEffect--;
        if (Math.random() < 0.005) glitchEffect = 20; // –†–∞–Ω–¥–æ–º–Ω—ã–π –≥–ª–∏—Ç—á

        // –î–≤–∏–∂–µ–Ω–∏–µ
        let speed = joy.active ? 4 : 0;
        let nx = player.x + joy.x * speed;
        let ny = player.y + joy.y * speed;
        
        // –ö–æ–ª–ª–∏–∑–∏–∏ —Å–æ —Å—Ç–µ–Ω–∞–º–∏
        let canMove = true;
        walls.forEach(w => {
            if (nx > w.x && nx < w.x + w.w && ny > w.y && ny < w.y + w.h) canMove = false;
            if (w.moving) w.x += Math.sin(Date.now()/1000) * 2; // –°—Ç–µ–Ω—ã –¥–≤–∏–≥–∞—é—Ç—Å—è!
        });
        if (canMove) { player.x = nx; player.y = ny; }
        
        if (player.invisible > 0) player.invisible--;

        // –õ–æ–≥–∏–∫–∞ –û—Ö–æ—Ç–Ω–∏–∫–∞
        let d = Math.hypot(hunter.x - player.x, hunter.y - player.y);
        
        // –û—Ö–æ—Ç–Ω–∏–∫ —Å–ª—ã—à–∏—Ç —à—É–º –∏–ª–∏ –≤–∏–¥–∏—Ç
        if (player.invisible <= 0 && (d < 150 || (player.noise > 50 && d < 400))) {
            hunter.alert = 100;
        }

        if (hunter.alert > 0) {
            let angle = Math.atan2(player.y - hunter.y, player.x - hunter.x);
            hunter.speed = 3;
            hunter.x += Math.cos(angle) * hunter.speed;
            hunter.y += Math.sin(angle) * hunter.speed;
            hunter.alert--;
        } else {
            hunter.speed = 1;
            hunter.x += Math.sin(Date.now()/1000) * 2;
            hunter.y += Math.cos(Date.now()/1500) * 2;
        }

        // –°–±–æ—Ä —É–∑–ª–æ–≤
        nodes.forEach(n => {
            if (n.active && Math.hypot(player.x - n.x, player.y - n.y) < 30) {
                n.active = false;
                document.getElementById('cores').innerText = nodes.filter(x => !x.active).length;
            }
        });

        document.getElementById('noise').innerText = Math.floor(player.noise);
        if (d < 35 && player.invisible <= 0) location.reload();
        if (nodes.every(n => !n.active)) { alert("–°–ò–°–¢–ï–ú–ê –í–ó–õ–û–ú–ê–ù–ê!"); location.reload(); }
    }

    function draw() {
        ctx.fillStyle = glitchEffect > 0 ? '#030' : '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –°—Ç–µ–Ω—ã
        ctx.strokeStyle = '#0f0';
        ctx.lineWidth = 2;
        walls.forEach(w => {
            ctx.strokeRect(w.x + (glitchEffect > 0 ? Math.random()*10 : 0), w.y, w.w, w.h);
        });

        // –£–∑–ª—ã
        nodes.forEach(n => {
            if (n.active) {
                ctx.fillStyle = '#0ff';
                ctx.shadowBlur = 15; ctx.shadowColor = '#0ff';
                ctx.beginPath(); ctx.arc(n.x, n.y, 8, 0, 7); ctx.fill();
                ctx.shadowBlur = 0;
            }
        });

        // –ò–≥—Ä–æ–∫
        ctx.font = "30px Arial";
        ctx.globalAlpha = player.invisible > 0 ? 0.3 : 1;
        ctx.fillText("üêÄ", player.x-15, player.y+15);
        ctx.globalAlpha = 1;

        // –û—Ö–æ—Ç–Ω–∏–∫
        ctx.fillStyle = hunter.alert > 0 ? '#f00' : '#555';
        ctx.font = "40px Arial";
        ctx.fillText(hunter.alert > 0 ? "üëπ" : "üëÅÔ∏è", hunter.x-20, hunter.y+20);
        
        // –õ–∏–Ω–∏–∏ —Å–∫–∞–Ω–µ—Ä–∞ –û—Ö–æ—Ç–Ω–∏–∫–∞
        if (hunter.alert > 0) {
            ctx.strokeStyle = 'rgba(255,0,0,0.3)';
            ctx.beginPath(); ctx.moveTo(hunter.x, hunter.y); ctx.lineTo(player.x, player.y); ctx.stroke();
        }
    }

    createWorld();
    setInterval(() => { update(); draw(); }, 1000/60);
</script>
</body>
</html>
