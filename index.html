<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RatOS: DOORS</title>
    <style>
        body { margin: 0; background: #050505; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; touch-action: none; }
        canvas { display: block; }
        .hud { position: absolute; top: 10px; width: 100%; text-align: center; font-size: 1.5rem; color: #ffcc00; text-shadow: 2px 2px #000; z-index: 10; pointer-events: none; }
        #joystick { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border: 2px solid #fff; border-radius: 50%; }
        #knob { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: #fff; border-radius: 50%; }
        #hide-btn { position: absolute; bottom: 40px; right: 40px; width: 90px; height: 90px; background: rgba(255,255,0,0.2); border: 3px solid #ff0; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="hud">–î–í–ï–†–¨: <span id="door-num">0</span></div>
<canvas id="game"></canvas>
<div id="joystick"><div id="knob"></div></div>
<div id="hide-btn">–®–ö–ê–§</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let door = 0;
    let player = { x: canvas.width/2, y: canvas.height - 100, hiding: false, lastDir: 0 };
    let rush = { active: false, x: -500, speed: 25 };
    let eyes = { active: false, x: 0, y: 0 };
    let flicker = 0;
    let joy = { x: 0, y: 0, active: false };

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    const hideBtn = document.getElementById('hide-btn');
    hideBtn.addEventListener('touchstart', () => { player.hiding = !player.hiding; hideBtn.style.background = player.hiding ? "#ff0" : "rgba(255,255,0,0.2)"; });

    document.getElementById('joystick').addEventListener('touchstart', () => joy.active = true);
    window.addEventListener('touchmove', (e) => {
        if (!joy.active) return;
        const rect = document.getElementById('joystick').getBoundingClientRect();
        const dx = e.touches[0].clientX - (rect.left + 50);
        const dy = e.touches[0].clientY - (rect.top + 50);
        const d = Math.sqrt(dx*dx + dy*dy);
        joy.x = dx / d; joy.y = dy / d;
        document.getElementById('knob').style.transform = `translate(${joy.x * Math.min(d, 40)}px, ${joy.y * Math.min(d, 40)}px)`;
    });
    window.addEventListener('touchend', () => { joy.active = false; joy.x = 0; joy.y = 0; document.getElementById('knob').style.transform = 'translate(0,0)'; });

    function nextRoom() {
        door++;
        player.x = canvas.width/2;
        player.y = canvas.height - 100;
        player.hiding = false;
        hideBtn.style.background = "rgba(255,255,0,0.2)";
        
        // –®–∞–Ω—Å –ø–æ—è–≤–ª–µ–Ω–∏—è –º–æ–Ω—Å—Ç—Ä–æ–≤
        if (Math.random() > 0.7) triggerRush();
        else if (Math.random() > 0.8) triggerEyes();
    }

    function triggerRush() {
        flicker = 60; // –°–≤–µ—Ç –º–∏–≥–∞–µ—Ç
        setTimeout(() => {
            rush.active = true;
            rush.x = -1000;
        }, 1500);
    }

    function triggerEyes() {
        eyes.active = true;
        eyes.x = canvas.width/2;
        eyes.y = canvas.height/2;
    }

    function update() {
        if (flicker > 0) flicker--;

        if (!player.hiding) {
            player.x += joy.x * 5;
            player.y += joy.y * 5;
        }

        // –ü—Ä–æ—Ö–æ–¥ –≤ –¥–≤–µ—Ä—å
        if (player.y < 50) nextRoom();

        // –õ–æ–≥–∏–∫–∞ RUSH
        if (rush.active) {
            rush.x += rush.speed;
            if (Math.abs(rush.x - player.x) < 100 && !player.hiding) {
                die("–†–ê–® –ó–ê–°–ü–û–†–¢–ò–õ –¢–ï–ë–Ø!");
            }
            if (rush.x > canvas.width + 1000) rush.active = false;
        }

        // –õ–æ–≥–∏–∫–∞ EYES
        if (eyes.active) {
            let dist = Math.hypot(player.x - eyes.x, player.y - eyes.y);
            if (dist < 200 && !player.hiding) {
                player.hiding = false; // –ì–ª–∞–∑–∞ –≤–∏–¥—è—Ç –≤—Å—ë
                die("–ù–ï –°–ú–û–¢–†–ò –ù–ê –ì–õ–ê–ó–ê!");
            }
            if (player.y < eyes.y - 100) eyes.active = false; // –ü—Ä–æ—à–µ–ª –º–∏–º–æ
        }

        document.getElementById('door-num').innerText = door;
    }

    function die(msg) {
        alert("–î–í–ï–†–¨ " + door + ": " + msg);
        door = 0;
        nextRoom();
    }

    function draw() {
        // –§–æ–Ω –∫–æ–º–Ω–∞—Ç—ã (—Ç–µ–º–Ω–µ–µ—Ç –µ—Å–ª–∏ –º–∏–≥–∞–µ—Ç —Å–≤–µ—Ç)
        ctx.fillStyle = flicker % 10 > 5 ? '#222' : '#050505';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –ö–æ—Ä–∏–¥–æ—Ä/–î–≤–µ—Ä—å
        ctx.strokeStyle = '#444';
        ctx.lineWidth = 5;
        ctx.strokeRect(50, 50, canvas.width-100, canvas.height-100);
        ctx.fillStyle = '#111';
        ctx.fillRect(canvas.width/2 - 40, 0, 80, 50); // –î–≤–µ—Ä—å –≤–ø–µ—Ä–µ–¥–∏

        // –®–∫–∞—Ñ (–∑–æ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
        ctx.fillStyle = '#321';
        ctx.fillRect(20, canvas.height/2 - 50, 40, 100);

        // –ò–≥—Ä–æ–∫
        if (!player.hiding) {
            ctx.font = "50px Arial";
            ctx.fillText("üêÄ", player.x-25, player.y+25);
        } else {
            ctx.fillStyle = "#ff0";
            ctx.font = "20px Arial";
            ctx.fillText("–í –®–ö–ê–§–£", player.x-40, player.y);
        }

        // –†–ê–®
        if (rush.active) {
            ctx.shadowBlur = 50; ctx.shadowColor = "#fff";
            ctx.font = "80px Arial";
            ctx.fillText("‚ò†Ô∏è", rush.x, canvas.height/2);
            ctx.shadowBlur = 0;
        }

        // –ì–õ–ê–ó–ê
        if (eyes.active) {
            ctx.font = "100px Arial";
            ctx.fillText("üëÅÔ∏èüëÅÔ∏è", eyes.x-60, eyes.y+30);
        }
    }

    nextRoom();
    setInterval(() => { update(); draw(); }, 1000/60);
</script>
</body>
</html>
