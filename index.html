<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RatOS: BREACH</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; touch-action: none; }
        canvas { display: block; }
        .hud { position: absolute; top: 10px; width: 100%; text-align: center; color: #0f0; pointer-events: none; font-size: 1.2rem; }
        #joystick { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(0,255,0,0.1); border: 2px solid #0f0; border-radius: 50%; }
        #knob { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: #0f0; border-radius: 50%; }
        #msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #f00; font-size: 2rem; display: none; text-align: center; }
    </style>
</head>
<body>

<div class="hud">–Ø–î–†–ê: <span id="cores">0</span> / 3 | –°–¢–ê–¢–£–°: <span id="status" style="color: #0f0;">–°–ö–†–´–¢</span></div>
<div id="msg">–û–ë–ù–ê–†–£–ñ–ï–ù!<br><span style="font-size: 1rem; color: #fff;">–°–ò–°–¢–ï–ú–ê –ü–ï–†–ï–ó–ê–ì–†–£–ñ–ï–ù–ê</span></div>
<canvas id="game"></canvas>
<div id="joystick"><div id="knob"></div></div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let player = { x: 50, y: 50, r: 15, speed: 4 };
    let hunter = { x: canvas.width-100, y: canvas.height-100, r: 30, speed: 2, state: 'patrol', targetIdx: 0 };
    let cores = [];
    let walls = [];
    let joy = { x: 0, y: 0, active: false };
    let patrolPoints = [
        {x: canvas.width-100, y: 100},
        {x: canvas.width-100, y: canvas.height-100},
        {x: 100, y: canvas.height-100},
        {x: 100, y: 100}
    ];

    function init() {
        walls = [];
        for(let i=0; i<10; i++) {
            walls.push({x: Math.random()*(canvas.width-100)+50, y: Math.random()*(canvas.height-100)+50, w: 80, h: 80});
        }
        cores = [];
        for(let i=0; i<3; i++) {
            cores.push({x: Math.random()*(canvas.width-40)+20, y: Math.random()*(canvas.height-40)+20, collected: false});
        }
    }

    // –î–∂–æ–π—Å—Ç–∏–∫
    const knob = document.getElementById('knob');
    document.getElementById('joystick').addEventListener('touchstart', () => joy.active = true);
    window.addEventListener('touchmove', (e) => {
        if (!joy.active) return;
        const rect = document.getElementById('joystick').getBoundingClientRect();
        const dx = e.touches[0].clientX - (rect.left + 50);
        const dy = e.touches[0].clientY - (rect.top + 50);
        const d = Math.sqrt(dx*dx + dy*dy);
        joy.x = dx / d; joy.y = dy / d;
        knob.style.transform = `translate(${joy.x * Math.min(d, 40)}px, ${joy.y * Math.min(d, 40)}px)`;
    });
    window.addEventListener('touchend', () => { joy.active = false; joy.x = 0; joy.y = 0; knob.style.transform = 'translate(0,0)'; });

    function update() {
        // –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
        let nextX = player.x + joy.x * player.speed;
        let nextY = player.y + joy.y * player.speed;
        
        let collision = false;
        walls.forEach(w => {
            if (nextX > w.x && nextX < w.x + w.w && nextY > w.y && nextY < w.y + w.h) collision = true;
        });
        if (!collision) { player.x = nextX; player.y = nextY; }

        // –ò–ò –û—Ö–æ—Ç–Ω–∏–∫–∞
        let distToPlayer = Math.hypot(hunter.x - player.x, hunter.y - player.y);
        let status = document.getElementById('status');
        
        if (distToPlayer < 250) { // –û—Ö–æ—Ç–Ω–∏–∫ –≤–∏–¥–∏—Ç –∏–≥—Ä–æ–∫–∞
            hunter.state = 'chase';
            status.innerText = "–û–ë–ù–ê–†–£–ñ–ï–ù";
            status.style.color = "#f00";
            hunter.speed = 3.5;
        } else {
            hunter.state = 'patrol';
            status.innerText = "–°–ö–†–´–¢";
            status.style.color = "#0f0";
            hunter.speed = 2;
        }

        if (hunter.state === 'chase') {
            let angle = Math.atan2(player.y - hunter.y, player.x - hunter.x);
            hunter.x += Math.cos(angle) * hunter.speed;
            hunter.y += Math.sin(angle) * hunter.speed;
        } else {
            let p = patrolPoints[hunter.targetIdx];
            let angle = Math.atan2(p.y - hunter.y, p.x - hunter.x);
            hunter.x += Math.cos(angle) * hunter.speed;
            hunter.y += Math.sin(angle) * hunter.speed;
            if (Math.hypot(hunter.x - p.x, hunter.y - p.y) < 10) hunter.targetIdx = (hunter.targetIdx + 1) % 4;
        }

        // –°–±–æ—Ä —è–¥–µ—Ä
        cores.forEach(c => {
            if (!c.collected && Math.hypot(player.x - c.x, player.y - c.y) < 30) {
                c.collected = true;
                document.getElementById('cores').innerText = cores.filter(core => core.collected).length;
            }
        });

        if (distToPlayer < 40) {
            document.getElementById('msg').style.display = 'block';
            setTimeout(() => location.reload(), 2000);
        }
        
        if (cores.every(c => c.collected)) {
            alert("–°–ò–°–¢–ï–ú–ê –í–ó–õ–û–ú–ê–ù–ê! –¢–´ –õ–£–ß–®–ò–ô –•–ê–ö–ï–†.");
            location.reload();
        }
    }

    function draw() {
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –¢—É–º–∞–Ω –≤–æ–π–Ω—ã (—Å–≤–µ—Ç –≤–æ–∫—Ä—É–≥ –∏–≥—Ä–æ–∫–∞)
        let grad = ctx.createRadialGradient(player.x, player.y, 10, player.x, player.y, 200);
        grad.addColorStop(0, 'rgba(0, 50, 0, 1)');
        grad.addColorStop(1, 'rgba(0, 0, 0, 1)');
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –°—Ç–µ–Ω—ã (–±–ª–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö)
        ctx.fillStyle = '#111';
        ctx.strokeStyle = '#0f0';
        walls.forEach(w => {
            ctx.fillRect(w.x, w.y, w.w, w.h);
            ctx.strokeRect(w.x, w.y, w.w, w.h);
        });

        // –Ø–¥—Ä–∞
        ctx.font = "30px Arial";
        cores.forEach(c => { if(!c.collected) ctx.fillText("üíé", c.x-15, c.y+15); });

        // –ò–≥—Ä–æ–∫
        ctx.fillText("üêÄ", player.x-15, player.y+15);

        // –û—Ö–æ—Ç–Ω–∏–∫
        ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';
        ctx.beginPath();
        ctx.arc(hunter.x, hunter.y, 250, 0, Math.PI*2); // –ó–æ–Ω–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏
        ctx.fill();
        ctx.font = "40px Arial";
        ctx.fillText("üëÅÔ∏è", hunter.x-20, hunter.y+20);
    }

    init();
    setInterval(() => { update(); draw(); }, 1000/60);
</script>
</body>
</html>
