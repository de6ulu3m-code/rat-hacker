<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RatOS: Dungeon Crawler</title>
    <style>
        body { margin: 0; background: #000; color: #0f0; font-family: 'Courier New', monospace; overflow: hidden; touch-action: none; }
        canvas { display: block; }
        .ui { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-around; pointer-events: none; font-size: 1.1rem; text-shadow: 2px 2px #000; }
        .mission { position: absolute; top: 50px; width: 100%; text-align: center; color: #ffcc00; font-weight: bold; }
        #joystick { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid #0f0; }
        #knob { position: absolute; top: 30px; left: 30px; width: 40px; height: 40px; background: #0f0; border-radius: 50%; }
        #fire-btn { position: absolute; bottom: 40px; right: 40px; width: 100px; height: 100px; background: rgba(255,0,0,0.3); border: 3px solid #f00; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; }
    </style>
</head>
<body>

<canvas id="game"></canvas>

<div class="ui">
    <div>‚ù§Ô∏è HP: <span id="hp">100</span></div>
    <div>üì¶ –≠–¢–ê–ñ: <span id="floor">1</span></div>
    <div>üéØ –í–†–ê–ì–û–í: <span id="enemies-left">0</span></div>
</div>

<div class="mission" id="msg">–ó–ê–ß–ò–°–¢–ò –ö–û–ú–ù–ê–¢–£, –ß–¢–û–ë–´ –ü–†–û–ô–¢–ò –î–ê–õ–¨–®–ï</div>

<div id="joystick"><div id="knob"></div></div>
<div id="fire-btn">–û–ì–û–ù–¨</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    
    let floor = 1;
    let cheese = parseInt(localStorage.getItem('ratCheese')) || 0;
    let player = { x: 100, y: 100, hp: 100, speed: 5, r: 20 };
    let enemies = [];
    let bullets = [];
    let gameActive = true;
    let exitOpen = false;

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    let joy = { x: 0, y: 0, active: false };
    const knob = document.getElementById('knob');

    function initFloor() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        player.x = 50; player.y = canvas.height / 2;
        enemies = [];
        bullets = [];
        exitOpen = false;
        
        // –°–ø–∞–≤–Ω–∏–º –º–æ–Ω—Å—Ç—Ä–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç—Ç–∞–∂–∞
        let count = 3 + floor;
        for(let i=0; i<count; i++) {
            enemies.push({
                x: 200 + Math.random() * (canvas.width - 300),
                y: Math.random() * canvas.height,
                hp: 2 + Math.floor(floor/2),
                type: Math.random() > 0.7 ? 'üòº' : 'üê¶',
                v: 1 + Math.random()
            });
        }
        updateUI();
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∂–æ–π—Å—Ç–∏–∫–∞
    const moveJoy = (e) => {
        if (!joy.active) return;
        const rect = document.getElementById('joystick').getBoundingClientRect();
        const cx = rect.left + 50, cy = rect.top + 50;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const dx = clientX - cx, dy = clientY - cy;
        const d = Math.sqrt(dx*dx + dy*dy);
        joy.x = dx / d; joy.y = dy / d;
        knob.style.transform = `translate(${joy.x * Math.min(d, 40)}px, ${joy.y * Math.min(d, 40)}px)`;
    };

    document.getElementById('joystick').addEventListener('touchstart', () => joy.active = true);
    window.addEventListener('touchmove', moveJoy);
    window.addEventListener('touchend', () => { joy.active = false; joy.x = 0; joy.y = 0; knob.style.transform = 'translate(0,0)'; });

    // –°—Ç—Ä–µ–ª—å–±–∞
    document.getElementById('fire-btn').addEventListener('touchstart', (e) => {
        e.preventDefault();
        // –°—Ç—Ä–µ–ª—è–µ–º –≤ —Å—Ç–æ—Ä–æ–Ω—É –¥–≤–∏–∂–µ–Ω–∏—è –∏–ª–∏ –Ω–∞–ø—Ä–∞–≤–æ
        let vx = joy.x !== 0 ? joy.x * 12 : 12;
        let vy = joy.y !== 0 ? joy.y * 12 : 0;
        bullets.push({ x: player.x, y: player.y, vx, vy });
    });

    function update() {
        if (!gameActive) return;

        player.x += joy.x * player.speed;
        player.y += joy.y * player.speed;

        // –ì—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
        player.x = Math.max(20, Math.min(canvas.width - 20, player.x));
        player.y = Math.max(20, Math.min(canvas.height - 20, player.y));

        bullets.forEach((b, bi) => {
            b.x += b.vx; b.y += b.vy;
            enemies.forEach((en, ei) => {
                if (Math.hypot(b.x - en.x, b.y - en.y) < 30) {
                    en.hp--;
                    bullets.splice(bi, 1);
                    if (en.hp <= 0) enemies.splice(ei, 1);
                }
            });
        });

        enemies.forEach(en => {
            let dx = player.x - en.x, dy = player.y - en.y;
            let d = Math.hypot(dx, dy);
            en.x += (dx / d) * en.v;
            en.y += (dy / d) * en.v;
            if (d < 30) player.hp -= 0.5;
        });

        if (enemies.length === 0) {
            exitOpen = true;
            document.getElementById('msg').innerText = "–ö–û–ú–ù–ê–¢–ê –ß–ò–°–¢–ê! –ò–î–ò –ö –ü–†–ê–í–û–ú–£ –ö–†–ê–Æ ‚Üí";
            if (player.x > canvas.width - 40) {
                floor++;
                initFloor();
                document.getElementById('msg').innerText = "–≠–¢–ê–ñ " + floor + ": –ó–ê–ß–ò–°–¢–ö–ê...";
            }
        }

        if (player.hp <= 0) {
            alert("–¢–´ –ü–ê–õ –ù–ê –≠–¢–ê–ñ–ï " + floor);
            location.reload();
        }
        updateUI();
    }

    function updateUI() {
        document.getElementById('hp').innerText = Math.ceil(player.hp);
        document.getElementById('floor').innerText = floor;
        document.getElementById('enemies-left').innerText = enemies.length;
    }

    function draw() {
        ctx.fillStyle = '#0a0a0a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –î–≤–µ—Ä—å
        if (exitOpen) {
            ctx.fillStyle = '#0f0';
            ctx.fillRect(canvas.width - 20, canvas.height/2 - 50, 20, 100);
        }

        // –ò–≥—Ä–æ–∫
        ctx.font = "40px Arial";
        ctx.fillText("üêÄ", player.x - 20, player.y + 15);

        // –í—Ä–∞–≥–∏
        enemies.forEach(en => {
            ctx.fillText(en.type, en.x - 15, en.y + 15);
            ctx.fillStyle = '#f00';
            ctx.fillRect(en.x - 20, en.y - 30, (en.hp/(2+floor/2))*40, 5);
        });

        // –ü—É–ª–∏
        ctx.fillStyle = '#ff0';
        bullets.forEach(b => ctx.beginPath() + ctx.arc(b.x, b.y, 5, 0, 7) + ctx.fill());
    }

    initFloor();
    setInterval(() => { update(); draw(); }, 1000/60);
</script>
</body>
</html>
