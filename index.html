<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RatOS: Dungeon Pro</title>
    <style>
        body { margin: 0; background: #050505; color: #0f0; font-family: 'Courier New', monospace; overflow: hidden; touch-action: none; user-select: none; }
        canvas { display: block; }
        .ui { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-around; pointer-events: none; z-index: 10; font-size: 1.2rem; text-shadow: 2px 2px #000; }
        #joystick { position: absolute; bottom: 40px; left: 40px; width: 110px; height: 110px; background: rgba(0,255,0,0.1); border-radius: 50%; border: 2px solid #0f0; }
        #knob { position: absolute; top: 35px; left: 35px; width: 40px; height: 40px; background: #0f0; border-radius: 50%; box-shadow: 0 0 15px #0f0; }
        #fire-btn { position: absolute; bottom: 40px; right: 40px; width: 110px; height: 110px; background: rgba(255,0,0,0.2); border: 3px solid #f00; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 1.2rem; box-shadow: 0 0 15px #f00; }
        .floor-msg { position: absolute; top: 60px; width: 100%; text-align: center; color: #ffcc00; font-size: 1.5rem; pointer-events: none; }
    </style>
</head>
<body>

<canvas id="game"></canvas>

<div class="ui">
    <div>‚ù§Ô∏è HP: <span id="hp">100</span></div>
    <div>üì¶ –≠–¢–ê–ñ: <span id="floor">1</span></div>
    <div>üéØ –¶–ï–õ–ò: <span id="enemies-left">0</span></div>
</div>
<div class="floor-msg" id="msg">–ó–ê–ß–ò–°–¢–ò –í–°–ï–•!</div>

<div id="joystick"><div id="knob"></div></div>
<div id="fire-btn">–û–ì–û–ù–¨</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    
    let floor = 1;
    let player = { x: 0, y: 0, hp: 100, speed: 5, lastDir: {x: 1, y: 0} };
    let enemies = [];
    let bullets = [];
    let joy = { x: 0, y: 0, active: false };
    let shooting = false;
    let lastFireDate = 0;

    function initFloor() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        player.x = 80; player.y = canvas.height / 2;
        enemies = [];
        bullets = [];
        let count = 4 + floor;
        for(let i=0; i<count; i++) {
            enemies.push({
                x: 300 + Math.random() * (canvas.width - 400),
                y: 50 + Math.random() * (canvas.height - 100),
                hp: 2 + Math.floor(floor/2),
                type: Math.random() > 0.6 ? 'üòº' : 'üê¶',
                v: 1.2 + (floor * 0.1)
            });
        }
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏–µ–º
    const knob = document.getElementById('knob');
    const handleJoy = (e) => {
        if (!joy.active) return;
        const rect = document.getElementById('joystick').getBoundingClientRect();
        const cx = rect.left + 55, cy = rect.top + 55;
        const touch = e.touches ? e.touches[0] : e;
        const dx = touch.clientX - cx, dy = touch.clientY - cy;
        const d = Math.sqrt(dx*dx + dy*dy);
        joy.x = dx / d; joy.y = dy / d;
        knob.style.transform = `translate(${joy.x * Math.min(d, 45)}px, ${joy.y * Math.min(d, 45)}px)`;
        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Å—Ç—Ä–µ–ª—å–±—ã
        if (d > 5) { player.lastDir = {x: joy.x, y: joy.y}; }
    };

    document.getElementById('joystick').addEventListener('touchstart', (e) => { joy.active = true; handleJoy(e); });
    window.addEventListener('touchmove', handleJoy);
    window.addEventListener('touchend', () => { joy.active = false; joy.x = 0; joy.y = 0; knob.style.transform = 'translate(0,0)'; });

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª—å–±–æ–π
    const fireBtn = document.getElementById('fire-btn');
    fireBtn.addEventListener('touchstart', (e) => { e.preventDefault(); shooting = true; });
    window.addEventListener('touchend', () => { shooting = false; });

    function update() {
        // –î–≤–∏–∂–µ–Ω–∏–µ
        player.x += joy.x * player.speed;
        player.y += joy.y * player.speed;
        player.x = Math.max(30, Math.min(canvas.width - 30, player.x));
        player.y = Math.max(30, Math.min(canvas.height - 30, player.y));

        // –õ–æ–≥–∏–∫–∞ —Å—Ç—Ä–µ–ª—å–±—ã (–≤–æ –≤—Å–µ —Å—Ç–æ—Ä–æ–Ω—ã)
        if (shooting && Date.now() - lastFireDate > 250) {
            bullets.push({ 
                x: player.x, 
                y: player.y, 
                vx: player.lastDir.x * 12, 
                vy: player.lastDir.y * 12 
            });
            lastFireDate = Date.now();
        }

        // –ü—É–ª–∏
        bullets.forEach((b, bi) => {
            b.x += b.vx; b.y += b.vy;
            enemies.forEach((en, ei) => {
                if (Math.hypot(b.x - en.x, b.y - en.y) < 30) {
                    en.hp--; bullets.splice(bi, 1);
                    if (en.hp <= 0) enemies.splice(ei, 1);
                }
            });
            if (b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) bullets.splice(bi, 1);
        });

        // –í—Ä–∞–≥–∏
        enemies.forEach(en => {
            let angle = Math.atan2(player.y - en.y, player.x - en.x);
            en.x += Math.cos(angle) * en.v;
            en.y += Math.sin(angle) * en.v;
            if (Math.hypot(player.x - en.x, player.y - en.y) < 35) player.hp -= 0.4;
        });

        if (enemies.length === 0) {
            document.getElementById('msg').innerText = "–û–¢–õ–ò–ß–ù–û! –ü–ï–†–ï–•–û–î –ù–ê –°–õ–ï–î–£–Æ–©–ò–ô –≠–¢–ê–ñ...";
            if (player.x > canvas.width - 50) { floor++; initFloor(); }
        } else {
            document.getElementById('msg').innerText = `–ó–ê–ß–ò–°–¢–ö–ê –≠–¢–ê–ñ–ê ${floor}`;
        }

        if (player.hp <= 0) location.reload();

        document.getElementById('hp').innerText = Math.ceil(player.hp);
        document.getElementById('floor').innerText = floor;
        document.getElementById('enemies-left').innerText = enemies.length;
    }

    function draw() {
        ctx.fillStyle = '#050505';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –í—ã—Ö–æ–¥
        if (enemies.length === 0) {
            ctx.fillStyle = '#0f0';
            ctx.fillRect(canvas.width - 15, canvas.height/2 - 60, 15, 120);
        }

        // –ò–≥—Ä–æ–∫
        ctx.font = "45px Arial";
        ctx.fillText("üêÄ", player.x - 22, player.y + 18);

        // –í—Ä–∞–≥–∏
        enemies.forEach(en => {
            ctx.fillText(en.type, en.x - 18, en.y + 15);
            ctx.fillStyle = '#f00';
            ctx.fillRect(en.x - 20, en.y - 35, 40 * (en.hp / (2 + floor/2)), 6);
        });

        // –ü—É–ª–∏ (—Å–≤–µ—Ç—è—â–∏–µ—Å—è)
        ctx.fillStyle = '#fff700';
        bullets.forEach(b => {
            ctx.beginPath(); ctx.arc(b.x, b.y, 6, 0, Math.PI*2); ctx.fill();
        });
    }

    initFloor();
    setInterval(() => { update(); draw(); }, 1000/60);
</script>
</body>
</html>
