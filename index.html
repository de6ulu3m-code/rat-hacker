<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RatOS: Chill Survivor</title>
    <style>
        body { margin: 0; background: #000; color: #0f0; font-family: 'Courier New', monospace; overflow: hidden; touch-action: none; user-select: none; }
        canvas { display: block; }
        .ui { position: absolute; top: 15px; width: 100%; display: flex; justify-content: space-around; pointer-events: none; font-size: 1.2rem; font-weight: bold; z-index: 10; text-shadow: 2px 2px #000; }
        #upgrade-screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .option { background: #1a1a1a; border: 2px solid #ffcc00; padding: 20px; margin: 10px; cursor: pointer; width: 300px; text-align: center; color: #ffcc00; border-radius: 15px; font-size: 1.1rem; }
        .option:hover { background: #ffcc00; color: #000; }
        #joystick { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); }
        #knob { position: absolute; top: 30px; left: 30px; width: 40px; height: 40px; background: #ffcc00; border-radius: 50%; box-shadow: 0 0 15px #ffcc00; }
    </style>
</head>
<body>

<canvas id="game"></canvas>

<div class="ui">
    <div>‚ù§Ô∏è <span id="hp">100</span>%</div>
    <div>‚≠ê LVL: <span id="lvl">1</span></div>
    <div>üßÄ <span id="cheese">0</span></div>
</div>

<div id="joystick"><div id="knob"></div></div>

<div id="upgrade-screen">
    <h2 style="color: #ffcc00;">–í–ó–õ–û–ú –ó–ê–í–ï–†–®–ï–ù! –í–´–ë–ï–†–ò –ë–û–ù–£–°:</h2>
    <div class="option" onclick="applyUpgrade('fireRate')">üî´ –ë–ï–®–ï–ù–´–ô –ú–ò–ù–ò–ì–ê–ù (–°–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª—å–Ω–æ—Å—Ç—å)</div>
    <div class="option" onclick="applyUpgrade('damage')">üí• –†–ê–ó–†–´–í–ù–´–ï –ü–£–õ–ò (–£—Ä–æ–Ω –ø–æ –ø–ª–æ—â–∞–¥–∏)</div>
    <div class="option" onclick="applyUpgrade('speed')">üëü –ö–†–û–°–°–û–í–ö–ò "–ê–ë–ò–ë–ê–°" (–°–∫–æ—Ä–æ—Å—Ç—å —Ö–æ–¥–∞)</div>
</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    let cheese = parseInt(localStorage.getItem('ratCheese')) || 0;

    let player = { x: 0, y: 0, hp: 100, maxHp: 100, speed: 4, lvl: 1, exp: 0, nextLvl: 100 };
    let enemies = [];
    let bullets = [];
    let gameActive = true;
    let stats = { fireRate: 350, damage: 20, lastShot: 0, range: 450, splash: 40 };

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    let joy = { x: 0, y: 0, active: false };
    const knob = document.getElementById('knob');

    function init() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        player.x = canvas.width / 2;
        player.y = canvas.height / 2;
    }

    const moveJoy = (e) => {
        if (!joy.active) return;
        const rect = document.getElementById('joystick').getBoundingClientRect();
        const cx = rect.left + 50, cy = rect.top + 50;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const dx = clientX - cx, dy = clientY - cy;
        const d = Math.sqrt(dx*dx + dy*dy);
        joy.x = dx / d; joy.y = dy / d;
        const limit = Math.min(d, 40);
        knob.style.transform = `translate(${joy.x * limit}px, ${joy.y * limit}px)`;
    };

    document.getElementById('joystick').addEventListener('mousedown', () => joy.active = true);
    document.getElementById('joystick').addEventListener('touchstart', () => joy.active = true);
    window.addEventListener('mousemove', moveJoy);
    window.addEventListener('touchmove', moveJoy);
    window.addEventListener('mouseup', () => { joy.active = false; joy.x = 0; joy.y = 0; knob.style.transform = 'translate(0,0)'; });
    window.addEventListener('touchend', () => { joy.active = false; joy.x = 0; joy.y = 0; knob.style.transform = 'translate(0,0)'; });

    function autoShoot() {
        if (!gameActive) return;
        let now = Date.now();
        if (now - stats.lastShot < stats.fireRate) return;

        let target = null;
        let minDist = stats.range;
        enemies.forEach(en => {
            let d = Math.hypot(en.x - player.x, en.y - player.y);
            if (d < minDist) { minDist = d; target = en; }
        });

        if (target) {
            const angle = Math.atan2(target.y - player.y, target.x - player.x);
            bullets.push({ x: player.x, y: player.y, vx: Math.cos(angle) * 14, vy: Math.sin(angle) * 14 });
            stats.lastShot = now;
        }
    }

    function spawnEnemy() {
        if (!gameActive || enemies.length > 20) return;
        const angle = Math.random() * Math.PI * 2;
        const dist = Math.max(canvas.width, canvas.height);
        enemies.push({ 
            x: player.x + Math.cos(angle) * dist, 
            y: player.y + Math.sin(angle) * dist, 
            hp: 20, 
            type: Math.random() > 0.8 ? 'üòº' : 'üê¶'
        });
    }

    setInterval(spawnEnemy, 1000);

    function update() {
        if (!gameActive) return;

        player.x += joy.x * player.speed;
        player.y += joy.y * player.speed;

        // –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è
        if (player.hp < player.maxHp) player.hp += 0.05;

        autoShoot();

        bullets.forEach((b, bi) => {
            b.x += b.vx; b.y += b.vy;
            enemies.forEach((en, ei) => {
                if (Math.hypot(en.x - b.x, en.y - b.y) < 30) {
                    // –£—Ä–æ–Ω –ø–æ –ø–ª–æ—â–∞–¥–∏ (Splash)
                    enemies.forEach(e => {
                        if (Math.hypot(e.x - b.x, e.y - b.y) < stats.splash) e.hp -= stats.damage;
                    });
                    bullets.splice(bi, 1);
                }
            });
            if (b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) bullets.splice(bi, 1);
        });

        enemies.forEach((en, ei) => {
            const angle = Math.atan2(player.y - en.y, player.x - en.x);
            en.x += Math.cos(angle) * 1.5;
            en.y += Math.sin(angle) * 1.5;

            if (en.hp <= 0) {
                enemies.splice(ei, 1);
                player.exp += 25;
                if (player.exp >= player.nextLvl) levelUp();
            }

            if (Math.hypot(en.x - player.x, en.y - player.y) < 40) {
                player.hp -= 0.2;
                if (player.hp <= 0) location.reload();
            }
        });

        document.getElementById('hp').innerText = Math.ceil(player.hp);
        document.getElementById('lvl').innerText = player.lvl;
        document.getElementById('cheese').innerText = cheese;
    }

    function draw() {
        ctx.fillStyle = '#050505';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –ò–≥—Ä–æ–∫
        ctx.font = "50px Arial";
        ctx.fillText("üêÄ", player.x - 25, player.y + 20);

        // –í—Ä–∞–≥–∏
        enemies.forEach(en => {
            ctx.font = "35px Arial";
            ctx.fillText(en.type, en.x - 15, en.y + 15);
        });

        // –ü—É–ª–∏
        ctx.fillStyle = "#ff0";
        bullets.forEach(b => {
            ctx.beginPath(); ctx.arc(b.x, b.y, 5, 0, Math.PI*2); ctx.fill();
        });
    }

    function levelUp() {
        gameActive = false;
        player.lvl++; player.exp = 0;
        cheese += 100;
        localStorage.setItem('ratCheese', cheese);
        document.getElementById('upgrade-screen').style.display = 'flex';
    }

    function applyUpgrade(type) {
        if (type === 'fireRate') stats.fireRate *= 0.6;
        if (type === 'damage') { stats.damage += 20; stats.splash += 30; }
        if (type === 'speed') player.speed += 1.5;
        document.getElementById('upgrade-screen').style.display = 'none';
        gameActive = true;
    }

    window.addEventListener('resize', init);
    init();
    setInterval(() => { update(); draw(); }, 1000/60);
</script>
</body>
</html>
