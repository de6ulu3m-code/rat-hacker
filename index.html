<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RatOS: The Complex</title>
    <style>
        body { margin: 0; background: #000; color: #0f0; font-family: 'Courier New', monospace; overflow: hidden; touch-action: none; }
        canvas { display: block; }
        .hud { position: absolute; top: 15px; width: 100%; text-align: center; pointer-events: none; font-size: 1.2rem; text-shadow: 2px 2px #000; }
        .controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-around; }
        .joy-area { width: 120px; height: 120px; background: rgba(255,255,255,0.05); border: 2px solid #333; border-radius: 50%; position: relative; }
        .knob { width: 50px; height: 50px; background: #0f0; border-radius: 50%; position: absolute; top: 35px; left: 35px; box-shadow: 0 0 15px #0f0; }
        #action-btn { width: 100px; height: 100px; background: rgba(0,255,0,0.1); border: 3px solid #0f0; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="hud">–£–†–û–í–ï–ù–¨: <span id="lvl">1</span> | –°–¢–ê–¢–£–°: <span id="task">–ù–ê–ô–î–ò –î–ò–°–ö–ï–¢–£ üíæ</span></div>
<canvas id="game"></canvas>

<div class="controls">
    <div class="joy-area" id="joy"><div class="knob" id="knob"></div></div>
    <div id="action-btn">–î–ï–ô–°–¢–í–ò–ï</div>
</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let level = 1;
    let player = { x: 50, y: canvas.height/2, r: 20, hasDisk: false, inVent: false };
    let disk = { x: 0, y: 0 };
    let term = { x: 0, y: 0 };
    let vent = { x: 20, y: 20 };
    let entity = { x: -1000, active: false };
    let joy = { x: 0, y: 0, active: false };
    let dangerTime = 0;

    function initLevel() {
        player.x = 50; player.y = canvas.height/2;
        player.hasDisk = false;
        player.inVent = false;
        disk = { x: canvas.width - 100, y: 100 + Math.random()*(canvas.height-200) };
        term = { x: canvas.width - 100, y: 100 + Math.random()*(canvas.height-200) };
        entity.active = false;
        dangerTime = 0;
        updateHUD();
    }

    // –î–∂–æ–π—Å—Ç–∏–∫
    const knob = document.getElementById('knob');
    document.getElementById('joy').addEventListener('touchstart', () => joy.active = true);
    window.addEventListener('touchmove', (e) => {
        if (!joy.active) return;
        const rect = document.getElementById('joy').getBoundingClientRect();
        const dx = e.touches[0].clientX - (rect.left + 60);
        const dy = e.touches[0].clientY - (rect.top + 60);
        const d = Math.sqrt(dx*dx + dy*dy);
        joy.x = dx / d; joy.y = dy / d;
        knob.style.transform = `translate(${joy.x * Math.min(d, 40)}px, ${joy.y * Math.min(d, 40)}px)`;
    });
    window.addEventListener('touchend', () => { joy.active = false; joy.x = 0; joy.y = 0; knob.style.transform = 'translate(0,0)'; });

    // –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
    document.getElementById('action-btn').addEventListener('touchstart', () => {
        if (Math.hypot(player.x - disk.x, player.y - disk.y) < 50) player.hasDisk = true;
        if (player.hasDisk && Math.hypot(player.x - term.x, player.y - term.y) < 50) {
            level++;
            initLevel();
        }
        if (Math.hypot(player.x - vent.x, player.y - vent.y) < 50) player.inVent = !player.inVent;
        updateHUD();
    });

    function updateHUD() {
        const t = document.getElementById('task');
        if (player.inVent) t.innerText = "–¢–´ –í –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò";
        else if (!player.hasDisk) t.innerText = "–ù–ê–ô–î–ò –î–ò–°–ö–ï–¢–£ üíæ";
        else t.innerText = "–ù–ï–°–ò –ö –¢–ï–†–ú–ò–ù–ê–õ–£ üìü";
        document.getElementById('lvl').innerText = level;
    }

    function update() {
        if (!player.inVent) {
            player.x += joy.x * 5;
            player.y += joy.y * 5;
        }

        dangerTime++;
        // –ö–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏–ª–µ—Ç–∞–µ—Ç —Å—É—â–Ω–æ—Å—Ç—å
        if (dangerTime > 800) {
            entity.active = true;
            entity.x += 25;
            if (entity.x > canvas.width + 500) {
                entity.active = false;
                entity.x = -1000;
                dangerTime = 0;
            }
            if (entity.active && Math.abs(entity.x - player.x) < 100 && !player.inVent) {
                alert("–°–£–©–ï–°–¢–í–û –ü–û–ô–ú–ê–õ–û –¢–ï–ë–Ø!");
                level = 1;
                initLevel();
            }
        }
    }

    function draw() {
        ctx.fillStyle = '#050505';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –°–≤–µ—Ç —Ñ–æ–Ω–∞—Ä–∏–∫–∞
        let grad = ctx.createRadialGradient(player.x, player.y, 10, player.x, player.y, 200);
        grad.addColorStop(0, 'rgba(0, 255, 0, 0.15)');
        grad.addColorStop(1, 'rgba(0, 0, 0, 1)');
        ctx.fillStyle = grad;
        ctx.fillRect(0,0, canvas.width, canvas.height);

        // –í–µ–Ω—Ç–∏–ª—è—Ü–∏—è
        ctx.fillStyle = '#333';
        ctx.fillRect(vent.x, vent.y, 60, 60);
        ctx.font = "20px Arial";
        ctx.fillText("üì¶ –í–ï–ù–¢", vent.x, vent.y - 10);

        // –û–±—ä–µ–∫—Ç—ã
        if (!player.hasDisk) {
            ctx.font = "40px Arial";
            ctx.fillText("üíæ", disk.x, disk.y);
        }
        ctx.fillText("üìü", term.x, term.y);

        // –ò–≥—Ä–æ–∫
        ctx.font = "50px Arial";
        ctx.globalAlpha = player.inVent ? 0.3 : 1;
        ctx.fillText("üêÄ", player.x - 25, player.y + 25);
        ctx.globalAlpha = 1;

        // –°—É—â–Ω–æ—Å—Ç—å (RUSH)
        if (entity.active) {
            ctx.fillStyle = '#f00';
            ctx.font = "100px Arial";
            ctx.fillText("üëπ", entity.x, canvas.height/2);
            // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            ctx.fillStyle = 'rgba(255,0,0,' + (Math.sin(Date.now()/100)+1)/2 + ')';
            ctx.fillRect(0,0, canvas.width, 10);
        }
    }

    initLevel();
    setInterval(() => { update(); draw(); }, 1000/60);
</script>
</body>
</html>
